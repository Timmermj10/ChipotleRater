<!DOCTYPE html>
<html>
<head>
    <title>Chipotle Locations</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
    <link rel="stylesheet" href="css/styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap" rel="stylesheet">
</head>
<body>
    <div id="banner">Chipotle Rater</div>
    <div id="map"></div>

    <!-- Modal Structure for when we click on a Chipotle location -->
    <div id="locationModal" style="display:none; position: fixed; left: 50%; top: 50%; transform: translate(-50%, -50%); background-color: white; padding: 20px; z-index: 1000; border-radius: 10px;">
        <span onclick="closeLocationModal()" class='close-button'>X</span>
        <div id="locationName">Name: </div>
        <div id="locationAddress">Address: </div>
        <div id="locationRating">Rating: </div>
        <button onclick="addRating()">Add Rating</button>
        <button onclick="viewRatings()">View Ratings</button>
    </div>

    <div id="ratingModal" style="display:none; position: fixed; left: 50%; top: 50%; transform: translate(-50%, -50%); background-color: white; padding: 20px; z-index: 1000; border-radius: 10px;">
        <span onclick="closeRatingModal()" class='close-button'>X</span>
        <h2 id="locationName">Chipotle Name</h2>
        <form id="ratingForm">
            <label>Food Quality: <span id="foodQualityValue">0</span>/5</label>
            <input type="range" min="0" max="10" value="0" step="1" class="slider" id="foodQuality">
            <label>Food Amount: <span id="foodAmountValue">0</span>/5</label>
            <input type="range" min="0" max="10" value="0" step="1" class="slider" id="foodAmount">
            <label>Service Quality: <span id="serviceQualityValue">0</span>/5</label>
            <input type="range" min="0" max="10" value="0" step="1" class="slider" id="serviceQuality">
            <label>Time Taken (minutes):</label>
            <input type="number" id="timeTaken">
            <label for="extraComments">Extra Comments:</label>
            <textarea id="extraComments" name="extraComments" rows="4" cols="50"></textarea>
            <label>Attach Picture:</label>
            <input type="file" id="foodPicture" accept="image/*">
            <button type="submit">Submit Rating</button>
        </form>
    </div>

    <!-- Transparent overlay to prevent map interactions when the modal is open -->
    <div id="mapOverlay" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: transparent; z-index: 400; display: none;"></div>

    <script>
        // Reset the sliders to their default values
        function resetSliders() {
            document.getElementById('foodQuality').value = 0;
            document.getElementById('foodAmount').value = 0;
            document.getElementById('serviceQuality').value = 0;

            // Update the displayed slider values if you have dynamic labels
            document.getElementById('foodQualityValue').textContent = '0';
            document.getElementById('foodAmountValue').textContent = '0';
            document.getElementById('serviceQualityValue').textContent = '0';

            // Optionally, reset the extra comments section
            document.getElementById('extraComments').value = '';
        }

        // Functions for the location modal
        function addRating() {
            openRatingModal();
        }

        function viewRatings() {
            console.log("View ratings");
        }

        function openLocationModal() {
            // Show the modal
            document.getElementById('locationModal').style.display = 'block';

            // Show the overlay (to prevent map interactions when the modal is open)
            document.getElementById('mapOverlay').style.display = 'block';
        }

        function closeLocationModal() {
            // Hide the modal
            document.getElementById('locationModal').style.display = 'none';

            // Hide the overlay (to allow for interactions with the map again)
            document.getElementById('mapOverlay').style.display = 'none';
        }

        // Functions for the rating modal
        function openRatingModal() {
            // The overlay will still be up from the location modal

            // Show the rating modal
            document.getElementById('ratingModal').style.display = 'block';
        }

        function closeRatingModal() {
            // The overlay will still be up from the location modal

            // Hide the rating modal
            document.getElementById('ratingModal').style.display = 'none';
        }

        // Handle form submission for the ratings form
        document.getElementById('ratingForm').addEventListener('submit', function(event) {
            event.preventDefault();

            const formData = {
                locationName: document.getElementById('locationName').textContent.replace('Name: ', ''),
                foodQuality: document.getElementById('foodQuality').value,
                foodAmount: document.getElementById('foodAmount').value,
                serviceQuality: document.getElementById('serviceQuality').value,
                timeTaken: document.getElementById('timeTaken').value,
                extraComments: document.getElementById('extraComments').value,
            };

            fetch('http://localhost:3001/api/submit-rating', {
                method: 'POST',
                headers: {
                'Content-Type': 'application/json',
                },
                body: JSON.stringify(formData),
            })
            .then(response => response.json())
            .then(data => {
                alert('Rating submitted!');
                // Reset the slider values
                resetSliders();
                // Close the ratings modal
                document.getElementById('ratingModal').style.display = 'none';
            })
            .catch((error) => {
                console.error('Error:', error);
            });
        });

        // Listen for updates to the sliders and update the span values
        document.addEventListener('DOMContentLoaded', function() {
            const updateSliderLabel = (sliderId, labelId) => {
                const slider = document.getElementById(sliderId);
                const label = document.getElementById(labelId);
                label.textContent = (slider.value / 2).toFixed(1);
                
                slider.addEventListener('input', function() {
                    label.textContent = (this.value / 2).toFixed(1);
                });
            };

            updateSliderLabel('foodQuality', 'foodQualityValue');
            updateSliderLabel('foodAmount', 'foodAmountValue');
            updateSliderLabel('serviceQuality', 'serviceQualityValue');
        });

        // Initialize the map
        var map = L.map('map', {
            attributionControl: false,
            minZoom: 5
        }).setView([38.5, -98], 5);
        
        // For zoomed out viewing
        var customIcon = L.divIcon({
            className: 'custom-icon',
            html: '<div style="background-color: rgba(68, 21, 0, 1); border-radius: 50%; width: 40px; height: 40px;"><img src="images/burrito.png" style="width: 20px; height: 20px; position: relative; top: 50%; left: 50%; transform: translate(-50%, -50%);"></div>',
            // Credits for the burrito icon: <a href="https://www.flaticon.com/free-icons/burrito" title="burrito icons">Burrito icons created by IconsNova - Flaticon</a>
            iconSize: [25, 25], // Size of the icon
            iconAnchor: [20, 0], // Point of the icon which will correspond to marker's location
            popupAnchor: [0, 0] // Point from which the popup should open relative to the iconAnchor
        });

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
        }).addTo(map);

        // Create a marker cluster group
        var markers = L.markerClusterGroup({
            showCoverageOnHover: false // This removes the blue polygon that shows the coverage of the cluster
        });

        // Fetch Chipotle locations from your API
        fetch('http://localhost:3000/api/chipotle-locations')
            .then(response => response.json())
            .then(data => {
                var allMarkers = [];
                data.forEach(location => {
                    // Add the squareIcon to each of the markers
                    var squareIcon = L.divIcon({
                        className: 'square-icon',
                        html: `<div style="background-color: rgba(68, 21, 0, 1); width: 40px; height: 40px;"><p>${location.name}</p><p>${location.rating}</p></div>`,
                        iconSize: [40, 40],
                        iconAnchor: [20, 0],
                        popupAnchor: [0, 0]
                    });
                    
                    // Define the marker at the given location, give it the custom icon
                    var marker = L.marker([location.latitude, location.longitude], {icon: customIcon});
                    
                    // Update the onClick function for the markers to display the modal
                    marker.on('click', function() {
                        document.getElementById('locationName').textContent = 'Name: ' + location.name;
                        document.getElementById('locationAddress').textContent = 'Address: ' + location.address;
                        document.getElementById('locationRating').textContent = 'Rating: ' + location.rating;

                        // Call the openLocationModal function
                        openLocationModal();
                    });

                    // Adjustments to the tooltip
                    marker.bindTooltip(location.name, {
                        permanent: false,
                        direction: 'top',
                    });
                    markers.addLayer(marker);
                    allMarkers.push({marker: marker, squareIcon: squareIcon});
                });

                map.addLayer(markers);

                // When we zoom far enough in, change the icon to the squareIcon
                map.on('zoomend', function() {
                    var zoomlevel = map.getZoom();
                    allMarkers.forEach(item => {
                        if (zoomlevel >= 10){
                            item.marker.setIcon(item.squareIcon);
                        } else {
                            item.marker.setIcon(customIcon);
                        }
                    });
                });
            });
    </script>
</body>
</html>